<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La Biblioteca Infinita: Guardianes del Conocimiento</title>
<meta name="description" content="Juego educativo para clasificar sitios confiables: Sala Segura, Cuarentena o Mostrador de Ayuda." />
<meta name="theme-color" content="#5e49ff" />
<style>
  :root{
    --bg:#0e0b1a; /* noche biblioteca */
    --panel:#1c1533;
    --panel-2:#261c47;
    --accent:#5e49ff; /* magia */
    --accent-2:#00d4ff; /* brillo */
    --safe:#12c48b;
    --warn:#f6c833;
    --danger:#ff5d5d;
    --text:#f6f3ff;
    --muted:#c9c2e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 800px at 20% -10%, #1d1640, var(--bg)) fixed;
    color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    line-height:1.25;
  }
  header{
    display:flex; gap:.75rem; align-items:center; justify-content:space-between;
    padding:.75rem 1rem; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(255,255,255,.08)
  }
  .title{
    display:flex; align-items:center; gap:.75rem; font-weight:800; letter-spacing:.2px; font-size:clamp(1rem, 1.5vw + .8rem, 1.6rem);
  }
  .title .spark{width:1.8rem; height:1.8rem; border-radius:50%; background: conic-gradient(from 180deg, var(--accent), var(--accent-2), var(--accent)); box-shadow:0 0 16px var(--accent-2);} 
  .btn{border:0; padding:.6rem .9rem; border-radius:999px; color:#0b0730; background:linear-gradient(90deg, var(--accent-2), var(--accent)); font-weight:700; cursor:pointer; transition:transform .1s ease;}
  .btn:focus-visible{outline:3px solid #fff}
  .btn:active{transform:scale(.98)}
  .ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18)}

  main{
    display:grid; grid-template-columns: 240px 1fr; grid-template-rows:auto 1fr auto; gap:1rem; padding:1rem; max-width:1200px; margin:0 auto;
  }
  @media (max-width: 900px){
    main{grid-template-columns: 1fr;}
    .destinos{grid-template-columns: 1fr;}
  }
  .panel{
    background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:1rem; box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .left{min-height:180px}
  .queue{display:flex; gap:.5rem; flex-wrap:wrap}
  .chip{padding:.35rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); font-size:.8rem}

  .inspect{
    display:grid; grid-template-columns: 1fr 320px; gap:1rem;
  }
  @media (max-width: 900px){ .inspect{grid-template-columns: 1fr;} }

  .book-area{display:flex; align-items:center; justify-content:center; min-height:260px; position:relative; overflow:hidden}
  .book{
    width:min(280px, 70vw); height:180px; border-radius:12px; background: linear-gradient(135deg,#ffe08a,#ffd1f3);
    box-shadow: 0 12px 24px rgba(0,0,0,.35); border:3px solid rgba(255,255,255,.6);
    transform: rotate(-2deg); transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
  }
  .book[draggable="true"]{cursor:grab}
  .book:active{cursor:grabbing}
  .cover{padding:12px; height:100%; display:flex; flex-direction:column; justify-content:space-between}
  .cover .top{display:flex; align-items:center; justify-content:space-between}
  .seal{width:42px; height:42px; border-radius:50%; display:inline-grid; place-items:center; background:#fff; color:#0b0730; font-weight:900; box-shadow:0 2px 8px rgba(0,0,0,.2)}
  .seal.school{background: #e6fff4; color:#064b31; border:2px solid var(--safe)}
  .ads{font-size:.75rem; color:#5b003b; font-weight:800; text-shadow:0 0 6px rgba(255,0,120,.8); animation: blink 1s infinite steps(1);}
  @keyframes blink{50%{opacity:.3}}
  .domain{font-size:1.05rem; font-weight:900; color:#130d3e; background:rgba(255,255,255,.7); padding:.25rem .5rem; border-radius:8px}
  .tld{padding:.05rem .35rem; border-radius:6px; margin-left:.25rem; font-weight:900}
  .tld.safe{background: #d5fff0; color:#066d51; border:1px solid var(--safe)}
  .tld.warn{background: #fff6d6; color:#6a4a00; border:1px solid var(--warn)}
  .tld.danger{background: #ffe0e0; color:#7a0010; border:1px solid var(--danger)}
  .dino{width:46px; height:46px; border-radius:10px; background: radial-gradient(circle at 40% 30%, #89f7, #4ad);
        display:inline-grid; place-items:center; color:#023; font-weight:900}

  .rules{font-size:.95rem; line-height:1.25}
  .rules ul{margin:.5rem 0 .25rem .9rem}
  .rules strong{color:#fff}

  .destinos{display:grid; grid-template-columns: repeat(3,1fr); gap:1rem}
  .drop{min-height:120px; border:2px dashed rgba(255,255,255,.25); border-radius:14px; padding:1rem; display:grid; place-items:center; text-align:center; transition: all .12s ease; background: rgba(255,255,255,.03)}
  .drop[aria-dropeffect="move"]{border-color: var(--accent)}
  .drop.safe{border-color: var(--safe)}
  .drop.warn{border-color: var(--warn)}
  .drop.danger{border-color: var(--danger)}
  .drop:focus-visible{outline:3px solid #fff}
  .drop .name{font-weight:900}

  footer.panel{display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; justify-content:space-between}
  .meters{display:flex; gap:1rem; align-items:center}
  .bar{height:10px; width:180px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
  .fill{height:100%; width:0%; background:linear-gradient(90deg,var(--accent-2),var(--accent)); transition:width .2s ease}
  .score{font-weight:900}
  .badges{display:flex; gap:.4rem}
  .badge{padding:.2rem .45rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); border-radius:8px; font-size:.85rem}

  /* dialogs */
  dialog{border:0; border-radius:16px; padding:0; overflow:hidden; color:#120c2b; max-width:min(760px, 96vw)}
  dialog::backdrop{background:rgba(6,2,25,.6)}
  .dlg{background:#fff; padding:1rem}
  .dlg .hd{display:flex; gap:.5rem; align-items:center}
  .dlg .hd h2{margin:.25rem 0}
  .dlg .content{display:grid; gap:.5rem}
  .dlg .actions{display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem}
  .video-demo{background:#000; color:#fff; height:160px; border-radius:12px; display:grid; place-items:center; font-weight:800}

  /* announcements */
  .toast{position:fixed; inset:auto 1rem 1rem auto; background:rgba(22,18,44,.9); color:#fff; padding:.6rem .8rem; border-radius:10px; border:1px solid rgba(255,255,255,.2); max-width: 340px}
  .toast[hidden]{display:none}

  /* confetti */
  .confetti{position:fixed; inset:0; pointer-events:none}

  /* subtle float */
  .float{animation:float 2.2s ease-in-out infinite}
  @keyframes float{50%{transform: translateY(-4px) rotate(-1deg)}}
</style>
</head>
<body>
  <header>
    <div class="title" aria-label="T√≠tulo del juego">
      <div class="spark" aria-hidden="true"></div>
      <span>La Biblioteca Infinita: <span style="opacity:.9">Guardianes del Conocimiento</span></span>
    </div>
    <div class="actions">
      <button id="btnReglas" class="btn ghost" aria-haspopup="dialog" aria-controls="dlgReglas">Reglas</button>
      <button id="btnBriefing" class="btn ghost" aria-haspopup="dialog" aria-controls="dlgBriefing">Entrenamiento</button>
      <button id="btnIniciar" class="btn" aria-label="Comenzar el juego">Comenzar</button>
    </div>
  </header>

  <main aria-describedby="sr-help">
    <p id="sr-help" class="visually-hidden">Usa Tab para moverte, Enter para soltar el libro en un destino. Teclas r√°pidas: 1 Sala Segura, 2 Cuarentena, 3 Mostrador de Ayuda.</p>

    <section class="panel left" aria-label="Pila de libros entrantes">
      <h2 style="margin-top:0">Pila de libros</h2>
      <div id="queue" class="queue" aria-live="polite"></div>
    </section>

    <section class="panel inspect" aria-label="√Årea de inspecci√≥n">
      <div class="book-area" id="bookArea">
      </div>
      <aside class="panel rules" aria-label="Reglas visibles">
        <h3 style="margin-top:0">üìú Reglas</h3>
        <ul>
          <li><strong>Plataforma escolar/oficial</strong> (escudo): <span style="color:var(--safe);font-weight:800">Sala Segura</span>.</li>
          <li><strong>Terminaciones confiables</strong> <code>.edu</code> <code>.org</code> <code>.gob</code>: generalmente <span style="color:var(--safe);font-weight:800">Seguras</span> si no hay se√±ales raras.</li>
          <li><strong>Terminaciones dudosas</strong> <code>.biz</code> <code>.info</code> o combinaciones como <em>.org.biz</em>: <span style="color:var(--warn);font-weight:800">Cuarentena</span>.</li>
          <li><strong>Si dudas</strong>, usa <span style="color:var(--accent-2);font-weight:800">Mostrador de Ayuda</span>.</li>
        </ul>
      </aside>
    </section>

    <section class="panel destinos" aria-label="Destinos">
      <button id="dropSegura" class="drop safe" role="button" aria-label="Sala Segura" aria-dropeffect="none" data-destino="SEGURA">
        <div class="name">‚úÖ Sala Segura</div>
        <div class="hint">(Tecla 1)</div>
      </button>
      <button id="dropCuarentena" class="drop warn" role="button" aria-label="Zona de Cuarentena" aria-dropeffect="none" data-destino="CUARENTENA">
        <div class="name">‚ùì Zona de Cuarentena</div>
        <div class="hint">(Tecla 2)</div>
      </button>
      <button id="dropAyuda" class="drop danger" role="button" aria-label="Mostrador de Ayuda" aria-dropeffect="none" data-destino="AYUDA">
        <div class="name">üßë‚Äçüè´ Mostrador de Ayuda</div>
        <div class="hint">(Tecla 3)</div>
      </button>
    </section>

    <footer class="panel" aria-label="Progreso y puntuaci√≥n">
      <div class="meters">
        <div class="badge" aria-live="polite">Libro: <span id="progLibro">0</span>/10</div>
        <div class="badge">Errores graves restantes: <span id="erroresRestantes">3</span></div>
        <div class="bar" aria-label="Barra de progreso"><div id="fill" class="fill"></div></div>
      </div>
      <div class="score" aria-live="polite">Puntos de Confianza: <span id="puntos">0</span></div>
      <div class="badges" aria-live="polite">
        <span class="badge" id="badgePerfecto" hidden>‚ú® ¬°Ronda perfecta!</span>
      </div>
    </footer>
  </main>

  <div id="toast" class="toast" role="status" aria-live="assertive" hidden></div>
  <canvas id="confetti" class="confetti" width="0" height="0" aria-hidden="true"></canvas>

  <dialog id="dlgReglas" aria-label="Reglas del juego">
    <div class="dlg">
      <div class="hd"><div class="seal school" aria-hidden="true">üìö</div><h2>Reglas del Guardi√°n</h2></div>
      <div class="content">
        <ul>
          <li>Escudo escolar = plataforma oficial ‚Üí Sala Segura.</li>
          <li>.edu / .org / .gob = generalmente confiables si no hay se√±ales extra√±as.</li>
          <li>.biz / .info o terminaciones mezcladas = ¬°Cuarentena!</li>
          <li>Si dudas, ¬°pide ayuda! (Mostrador de Ayuda)</li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn ghost" data-close>Listo</button>
      </div>
    </div>
  </dialog>

  <dialog id="dlgBriefing" aria-label="Entrenamiento">
    <div class="dlg">
      <div class="hd"><div class="seal" aria-hidden="true">üéß</div><h2>Entrenamiento con la Bibliotecaria</h2></div>
      <div class="content">
        <div class="video-demo" aria-hidden="true">Voz en off + mini demo</div>
        <ol>
          <li>Libro escolar con escudo ‚Üí <strong>Sala Segura</strong>.</li>
          <li>Terminaciones <code>.edu .org .gob</code> ‚Üí <strong>Confiables</strong>.</li>
          <li><code>.biz .info</code> o anuncios parpadeantes ‚Üí <strong>Cuarentena</strong> o <strong>Ayuda</strong>.</li>
        </ol>
        <p>Cuando est√©s listo, pulsa ‚ÄúComenzar a clasificar‚Äù.</p>
      </div>
      <div class="actions">
        <button class="btn" id="btnComenzar">Comenzar a clasificar</button>
      </div>
    </div>
  </dialog>

  <dialog id="dlgFin" aria-label="Fin de la ronda">
    <div class="dlg">
      <div class="hd"><div class="seal" aria-hidden="true">üîë</div><h2 id="finTitulo">Llave Dorada de la Biblioteca</h2></div>
      <div class="content">
        <p id="finResumen"></p>
        <p class="frase" id="frasePoder" hidden>‚Äú¬°Con ojo de guardi√°n y mucha atenci√≥n, protejo a mi mundo de la desinformaci√≥n!‚Äù</p>
      </div>
      <div class="actions">
        <button class="btn" id="btnReintentar">Reintentar ronda</button>
      </div>
    </div>
  </dialog>

  <script>
  const LIBROS_BASE = [
    {
      id: 1,
      titulo: "TareasColegioSol.net",
      pistas: { logoEscolar: true, terminacion: ".net", anuncios: false, ambiguo: false },
      destinoCorrecto: "SEGURA"
    },
    {
      id: 2,
      titulo: "museodeciencias.org",
      pistas: { logoEscolar: false, terminacion: ".org", anuncios: false, ambiguo: false },
      destinoCorrecto: "SEGURA"
    },
    {
      id: 3,
      titulo: "juegosymas.info",
      pistas: { logoEscolar: false, terminacion: ".info", anuncios: true, ambiguo: false },
      destinoCorrecto: "CUARENTENA"
    },
    {
      id: 4,
      titulo: "animalesfantasticos.com",
      pistas: { logoEscolar: false, terminacion: ".com", anuncios: false, ambiguo: true },
      destinoCorrecto: "AYUDA"
    },
    {
      id: 5,
      titulo: "museodeciencias.org.biz",
      pistas: { logoEscolar: false, terminacion: ".biz", anuncios: false, ambiguo: false },
      destinoCorrecto: "CUARENTENA"
    }
  ];
  const state = {
    ronda: [],
    idx: 0,
    puntos: 0,
    graves: 0,
    ayudasBien: 0,
    confiablesPorDominio: 0,
  };
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'es-MX';
      u.rate = 1; u.pitch = 1; u.volume = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }
  const audioCtx = (()=>{ try{ return new (window.AudioContext||window.webkitAudioContext)(); }catch{ return null } })();
  function beep(freq=600, dur=0.08, type='triangle'){
    if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.setValueAtTime(.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(.0001, audioCtx.currentTime+dur); o.stop(audioCtx.currentTime+dur);
  }
  function bookClickEffect(el){ el.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:250}); }
  function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.hidden=false; setTimeout(()=>t.hidden=true, 2200); }
  const TLD_SAFE = ['.edu','.org','.gob'];
  const TLD_WARN = ['.biz','.info'];
  const TLD_NEUTRAL = ['.com','.net'];
  const NOMBRES = ['planetario','biblioteca','aprendefacil','museo','clubrobot','tallerideas','descubre','aulaonline','animales','viajes','cuento','noticias','videojuegos','ciencia','arte','historia'];
  function generarLibroAleatorio(id){
    const base = NOMBRES[Math.floor(Math.random()*NOMBRES.length)];
    const roll = Math.random();
    let tld = roll<.35? TLD_SAFE[Math.floor(Math.random()*TLD_SAFE.length)] : roll<.7? TLD_NEUTRAL[Math.floor(Math.random()*TLD_NEUTRAL.length)] : TLD_WARN[Math.floor(Math.random()*TLD_WARN.length)];
    let tricky = Math.random()<.15;
    let titulo = base + (Math.random()<.4? 'de' : '') + 'ciencias';
    if(tricky && tld === '.org') titulo += '.org.biz'; else titulo += tld;
    const logoEscolar = Math.random()<.18;
    const anuncios = !logoEscolar && (tld==='.info' || Math.random()<.2);
    const ambiguo = !logoEscolar && !anuncios && (tld==='.com') && Math.random()<.6;
    const pistas = {logoEscolar, terminacion: tricky? '.biz' : tld, anuncios, ambiguo};
    let destinoCorrecto = 'CUARENTENA';
    if(logoEscolar) destinoCorrecto = 'SEGURA';
    else if(tricky || TLD_WARN.includes(pistas.terminacion)) destinoCorrecto = 'CUARENTENA';
    else if(ambiguo) destinoCorrecto = 'AYUDA';
    else if(TLD_SAFE.includes(pistas.terminacion)) destinoCorrecto = 'SEGURA';
    else if(pistas.terminacion==='.com' || pistas.terminacion==='.net') destinoCorrecto = 'AYUDA';
    return { id, titulo, pistas, destinoCorrecto };
  }
  function barajar(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }
  function renderQueue(){
    const q = $('#queue'); q.innerHTML='';
    state.ronda.slice(state.idx+1).forEach((b)=>{
      const chip = document.createElement('span'); chip.className='chip'; chip.textContent = (b.titulo.length>18? b.titulo.slice(0,18)+'‚Ä¶': b.titulo);
      chip.setAttribute('aria-hidden','true'); q.appendChild(chip);
    });
  }
  function renderLibro(){
    const area = $('#bookArea'); area.innerHTML = '';
    const libro = state.ronda[state.idx];
    if(!libro){ area.innerHTML = '<p>¬°No hay m√°s libros! Pulsa Reintentar.</p>'; return; }
    const book = document.createElement('div'); book.className='book float'; book.tabIndex=0; book.setAttribute('role','img'); book.setAttribute('aria-label', `Portada del libro ${libro.titulo}`);
    book.draggable = true; book.id='book';
    book.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', 'book'); setDropEffect('move'); });
    book.addEventListener('dragend', ()=>{ setDropEffect('none'); });
    const cover = document.createElement('div'); cover.className='cover';
    const top = document.createElement('div'); top.className='top';
    const seal = document.createElement('div');
    if(libro.pistas.logoEscolar){ seal.className='seal school'; seal.title='Plataforma escolar'; seal.textContent='üè´'; }
    else if(libro.pistas.anuncios){ seal.className='seal'; seal.innerHTML='<span class="ads">ANUNCIOS</span>'; seal.title='Anuncios parpadeantes'; }
    else { seal.className='seal'; seal.textContent='üìñ'; }
    const icon = document.createElement('div'); icon.className='dino'; icon.textContent='ü¶ï'; icon.title='Ilustraci√≥n educativa';
    top.appendChild(seal); top.appendChild(icon);
    const domain = document.createElement('div'); domain.className='domain';
    const titulo = libro.titulo;
    const tld = libro.pistas.terminacion;
    const base = titulo.replace(tld,'');
    const spanBase = document.createElement('span'); spanBase.textContent = base;
    const spanTld = document.createElement('span'); spanTld.textContent = tld; spanTld.className='tld '+(TLD_SAFE.includes(tld)?'safe': TLD_WARN.includes(tld)? 'danger' : 'warn'); spanTld.setAttribute('aria-label','terminaci√≥n de dominio');
    domain.appendChild(spanBase); domain.appendChild(spanTld);
    cover.appendChild(top); cover.appendChild(domain);
    book.appendChild(cover);
    book.addEventListener('click', ()=>bookClickEffect(book));
    area.appendChild(book);
    renderQueue();
    updateProgress();
  }
  function setDropEffect(mode){
    $$('#dropSegura, #dropCuarentena, #dropAyuda').forEach(z=>z.setAttribute('aria-dropeffect', mode));
  }
  function evaluar(libro, destino){
    let tipoFeedback = '';
    let correcto = false;
    let grave = false; let menor = false; let bonoAyuda = false; let confiableDominio = false;
    if(destino === libro.destinoCorrecto){
      correcto = true;
      if(destino==='AYUDA'){ bonoAyuda = true; }
      if(destino==='SEGURA' && ['.edu','.org','.gob'].includes(libro.pistas.terminacion)) confiableDominio = true;
    } else {
      if(libro.destinoCorrecto==='CUARENTENA' && destino==='SEGURA'){ grave = true; }
      else if(libro.destinoCorrecto==='SEGURA' && destino==='CUARENTENA'){ menor = true; }
      else if(libro.destinoCorrecto==='AYUDA') { menor = true; }
      else { menor = true; }
    }
    if(correcto){ tipoFeedback = destino==='AYUDA' ? 'ayuda-bien' : 'correcto'; }
    else { tipoFeedback = grave? 'error-grave' : 'error-menor'; }
    return {correcto, grave, menor, bonoAyuda, confiableDominio, tipoFeedback};
  }
  function aplicarFeedback(tipo){
    switch(tipo){
      case 'correcto':
        beep(740,.08,'sine'); beep(880,.08,'sine'); speak('¬°Clasificaci√≥n perfecta! ¬°Has protegido a nuestros lectores!');
        showToast('‚úÖ ¬°Clasificaci√≥n perfecta!');
        break;
      case 'ayuda-bien':
        beep(660,.07,'triangle'); speak('¬°Excelente decisi√≥n! ¬°Ante la duda, preguntar!');
        showToast('üßë‚Äçüè´ ¬°Bien! Elegiste pedir ayuda.');
        break;
      case 'error-grave':
        beep(200,.2,'square'); setTimeout(()=>beep(200,.2,'square'), 220);
        speak('¬°Alerta! Revisa las pistas con m√°s cuidado.');
        showToast('üö® Error grave: libro peligroso en Sala Segura.');
        $('#book').style.filter='hue-rotate(25deg)';
        break;
      case 'error-menor':
        beep(400,.07,'sawtooth'); speak('Era seguro, pero buena precauci√≥n.');
        showToast('‚ÑπÔ∏è No era la mejor opci√≥n. Piensa en las pistas.');
        break;
    }
  }
  function actualizarPuntaje(res){
    if(res.correcto){ state.puntos += 10; }
    if(res.bonoAyuda){ state.puntos += 5; state.ayudasBien++; }
    if(res.confiableDominio){ state.confiablesPorDominio++; }
    if(res.grave){ state.puntos -= 15; state.graves++; $('#erroresRestantes').textContent = Math.max(0, 3 - state.graves); }
    if(res.menor && !res.grave){ state.puntos -= 5; }
    $('#puntos').textContent = state.puntos;
  }
  function nextOrEnd(){
    if(state.graves>=3){ terminarRonda(false); return; }
    state.idx++;
    if(state.idx>=state.ronda.length){ terminarRonda(true); }
    else { renderLibro(); }
  }
  function updateProgress(){
    $('#progLibro').textContent = Math.min(state.idx+1, state.ronda.length);
    const pct = (state.idx/state.ronda.length)*100; $('#fill').style.width = pct + '%';
  }
  function clasificar(destino){
    const libro = state.ronda[state.idx]; if(!libro) return;
    const res = evaluar(libro, destino);
    aplicarFeedback(res.tipoFeedback);
    ofrecerPistaSiFalla(res, libro);
    actualizarPuntaje(res);
    setTimeout(nextOrEnd, 250);
  }
  function ofrecerPistaSiFalla(res, libro){
    if(res.correcto) return;
    if(libro.pistas.terminacion){ showToast('üí° Mira el final del t√≠tulo: esa es la terminaci√≥n.'); }
    if(libro.titulo.includes('.org') && libro.pistas.terminacion!=='.org'){ showToast('üí° Si se parece a .org pero termina en otra cosa, no es confiable.'); }
    if(!libro.pistas.logoEscolar && !libro.pistas.ambiguo){ showToast('üí° Si dudas, lleva el libro al Mostrador de Ayuda.'); }
  }
  function terminarRonda(victoria){
    const dlg = $('#dlgFin');
    const total = state.ronda.length;
    const titulo = victoria && state.graves===0? 'üèÜ ¬°Llave Dorada de la Biblioteca!' : (victoria? '¬°Turno completado!' : 'Repaso necesario');
    $('#finTitulo').textContent = titulo;
    const resumen = `¬°Turno completado! Clasificaste ${total} libros, identificaste ${state.confiablesPorDominio} sitios confiables por su dominio y usaste el Mostrador de Ayuda ${state.ayudasBien} ${state.ayudasBien===1?'vez':'veces'}.`;
    $('#finResumen').textContent = resumen;
    $('#frasePoder').hidden = !(victoria && state.graves===0);
    if(victoria && state.graves===0){ lanzarConfeti(); speak('¬°Magn√≠fico! Ronda perfecta.'); }
    dlg.showModal();
  }
  function lanzarConfeti(){
    const c = $('#confetti'); const ctx = c.getContext('2d');
    c.width = innerWidth; c.height = innerHeight;
    const parts = Array.from({length: 120}, ()=>({
      x: Math.random()*c.width, y: -20-Math.random()*c.height,
      s: 4+Math.random()*6, vy: 2+Math.random()*3, vx: (-1+Math.random()*2), color:`hsl(${Math.random()*360},90%,60%)`
    }));
    let t=0; (function loop(){ ctx.clearRect(0,0,c.width,c.height); parts.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.s,p.s); }); t++; if(t<160) requestAnimationFrame(loop); })();
    setTimeout(()=>{ c.width=0; c.height=0; }, 2200);
  }
  function wireDestinos(){
    $$('#dropSegura, #dropCuarentena, #dropAyuda').forEach(btn=>{
      btn.addEventListener('dragover', e=>{ e.preventDefault(); });
      btn.addEventListener('drop', e=>{ e.preventDefault(); clasificar(btn.dataset.destino); setDropEffect('none'); });
      btn.addEventListener('click', ()=>{ clasificar(btn.dataset.destino); });
      btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); clasificar(btn.dataset.destino);} });
    });
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key==='1') { $('#dropSegura').focus(); clasificar('SEGURA'); }
      if(e.key==='2') { $('#dropCuarentena').focus(); clasificar('CUARENTENA'); }
      if(e.key==='3') { $('#dropAyuda').focus(); clasificar('AYUDA'); }
    });
  }
  function iniciarJuego(){
    state.ronda = [...LIBROS_BASE];
    const needed = 10 - state.ronda.length;
    for(let i=0;i<needed;i++){ state.ronda.push(generarLibroAleatorio(100+i)); }
    const primerosCinco = LIBROS_BASE.slice(0,5);
    const resto = state.ronda.slice(5);
    state.ronda = [...primerosCinco, ...barajar(resto)];
    state.idx = 0; state.puntos = 0; state.graves = 0; state.ayudasBien = 0; state.confiablesPorDominio = 0;
    $('#puntos').textContent = '0'; $('#erroresRestantes').textContent = '3'; $('#badgePerfecto').hidden = true;
    renderLibro();
    speak('Bienvenido Guardi√°n. Arrastra el libro o pulsa 1, 2 o 3 para clasificar.');
  }
  function siguienteLibro(){
    nextOrEnd();
  }
  function setupDialogs(){
    const r=$('#dlgReglas'); const b=$('#dlgBriefing');
    $('#btnReglas').addEventListener('click', ()=>{ r.showModal(); });
    $('#btnBriefing').addEventListener('click', ()=>{ b.showModal(); demoBriefing(); });
    r.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) r.close(); });
    $('#btnComenzar').addEventListener('click', ()=>{ b.close(); iniciarJuego(); });
    $('#btnIniciar').addEventListener('click', ()=>{ iniciarJuego(); });
    $('#btnReintentar').addEventListener('click', ()=>{ $('#dlgFin').close(); iniciarJuego(); });
  }
  function demoBriefing(){
    speak('Observa las pistas: si ves el escudo escolar, es plataforma oficial y va a Sala Segura. Las terminaciones punto edu, punto org y punto gob suelen ser confiables. Si ves punto biz o punto info, o anuncios parpadeantes, m√°ndalo a Cuarentena. Si te quedas con duda, usa el Mostrador de Ayuda.');
  }
  function addSRHelpers(){
    const style = document.createElement('style'); style.textContent = '.visually-hidden{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap;}'; document.head.appendChild(style);
  }
  async function registerSW(){
    if(!('serviceWorker' in navigator)) return;
    try{
      const swCode = `self.addEventListener('install', e=>{e.waitUntil(caches.open('biblioteca-v1').then(c=>c.addAll(['./'])))});self.addEventListener('fetch', e=>{e.respondWith(caches.match(e.request).then(r=>r || fetch(e.request).catch(()=>caches.match('./'))))});`;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url);
    }catch(e){}
  }
  function renderInicial(){
    wireDestinos(); addSRHelpers(); setupDialogs(); renderQueue(); renderLibro(); registerSW();
  }
  window.iniciarJuego = iniciarJuego;
  window.siguienteLibro = siguienteLibro;
  window.renderLibro = renderLibro;
  window.clasificar = clasificar;
  window.evaluar = evaluar;
  window.aplicarFeedback = aplicarFeedback;
  window.actualizarPuntaje = actualizarPuntaje;
  window.terminarRonda = terminarRonda;
  document.addEventListener('DOMContentLoaded', renderInicial);
  </script>
</body>
</html>
