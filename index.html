<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>La Biblioteca Infinita: Guardianes del Conocimiento</title>
<meta name="description" content="Juego educativo de Ciudadan√≠a Digital. Clasifica sitios web y aprende a navegar seguro." />
<meta name="theme-color" content="#5e49ff" />
<style>
  :root{
    --bg:#0e0b1a; 
    --panel:rgba(28, 21, 51, 0.95);
    --accent:#5e49ff; 
    --accent-light:#8b7dff;
    --safe:#12c48b;
    --warn:#f6c833;
    --danger:#ff5d5d;
    --text:#f6f3ff;
    --gold: #ffd700;
  }
  *{box-sizing:border-box; user-select: none; -webkit-user-select: none;}
  html,body{height:100%; overflow:hidden;}
  body{
    margin:0; background: radial-gradient(circle at 50% -20%, #2a2055, var(--bg)) fixed;
    color:var(--text); 
    font-family: 'Segoe UI', system-ui, sans-serif;
    line-height:1.4;
  }

  /* --- HEADER --- */
  header{
    display:flex; gap:.5rem; align-items:center; justify-content:space-between;
    padding:.5rem 1rem; background:rgba(14,11,26,0.85);
    position:sticky; top:0; z-index:20; backdrop-filter: blur(8px);
    border-bottom:1px solid rgba(255,255,255,.08);
    height: 60px;
  }
  .title{
    display:flex; align-items:center; gap:.5rem; font-weight:800; font-size:1.1rem;
  }
  .spark{width:1.2rem; height:1.2rem; border-radius:50%; background: conic-gradient(from 180deg, var(--accent), #00d4ff, var(--accent)); box-shadow:0 0 10px #00d4ff;} 

  .btn-icon{
    background:transparent; border:1px solid rgba(255,255,255,0.2); color:#fff;
    border-radius:50%; width:36px; height:36px; cursor:pointer; font-size:1.2rem;
    transition: background 0.2s; display:grid; place-items:center;
  }
  .btn-icon:hover{background:rgba(255,255,255,0.1);}

  /* --- MAIN LAYOUT --- */
  main{
    display:grid; 
    grid-template-rows: auto 1fr auto; 
    gap:1rem; padding:1rem; 
    max-width:800px; margin:0 auto; height: calc(100% - 60px);
    position: relative;
  }

  /* --- BIBLIOTECARIA --- */
  .librarian-area {
    display:flex; gap:1rem; align-items:flex-start; min-height:80px;
    background: var(--panel); border-radius:12px; padding:1rem;
    border:1px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: transform 0.3s;
  }
  .avatar {
    width:60px; height:60px; border-radius:50%; background:#fff; 
    border:3px solid var(--accent); flex-shrink:0; overflow:hidden;
    position:relative;
  }
  .dialog-bubble {
    position:relative; background:rgba(255,255,255,0.1); 
    padding:0.8rem; border-radius:0 12px 12px 12px;
    font-size:0.95rem; line-height:1.3; color:#fff;
  }
  .dialog-bubble::before {
    content:''; position:absolute; top:0; left:-10px;
    border-top:10px solid rgba(255,255,255,0.1); border-left:10px solid transparent;
  }

  /* --- STAGE LIBRO --- */
  .book-stage {
    flex:1; display:flex; align-items:center; justify-content:center;
    perspective: 1000px; position:relative;
  }
  
  .book {
    width: min(280px, 70vw); height: 180px;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    border-radius: 6px 10px 10px 6px;
    box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
    position: relative; border-left: 12px solid #1a252f;
    display:flex; flex-direction:column; padding:15px; padding-left:25px;
    transform: rotateY(-5deg); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .book[data-type="school"] { background: linear-gradient(135deg, #0ba360, #3cba92); border-left-color: #065f37; }
  .book[data-type="safe"] { background: linear-gradient(135deg, #4facfe, #00f2fe); border-left-color: #0076a3; }
  .book[data-type="warn"] { background: linear-gradient(135deg, #ff416c, #ff4b2b); border-left-color: #960018; }
  .book[data-type="ads"] { background: linear-gradient(135deg, #ffecd2, #fcb69f); border-left-color: #d35400; }
  
  .book-seal {
    width:45px; height:45px; background:#fff; border-radius:50%;
    display:grid; place-items:center; font-size:1.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    align-self: flex-end; margin-bottom: auto;
  }
  .book-title {
    background: rgba(255,255,255,0.9); color:#000;
    padding:8px 12px; border-radius:4px; font-weight:800; font-size:1.1rem;
    text-align:center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    word-break: break-all;
  }
  .book-tld { color: var(--accent); }

  /* Animaciones */
  .anim-enter { animation: flyIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
  .anim-safe { animation: flySafe 0.5s forwards; }
  .anim-warn { animation: flyWarn 0.5s forwards; }
  .anim-help { animation: flyHelp 0.5s forwards; }

  @keyframes flyIn { from { opacity:0; transform: translateY(100px) rotateX(20deg); } to { opacity:1; transform: translateY(0) rotateY(-5deg); } }
  @keyframes flySafe { to { opacity:0; transform: translate(-200px, 100px) rotate(-45deg); } }
  @keyframes flyWarn { to { opacity:0; transform: translate(200px, 100px) rotate(45deg); } }
  @keyframes flyHelp { to { opacity:0; transform: translateY(-100px) scale(0.5); } }

  /* --- CONTROLES --- */
  .controls {
    display:grid; grid-template-columns: 1fr 1fr 1fr; gap:0.8rem;
    padding-bottom: 1rem;
  }
  .btn-action {
    background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 15px 5px; color: #fff; cursor: pointer;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition: all 0.15s; position: relative;
  }
  .btn-action:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
  .btn-action:not(:disabled):hover { transform: translateY(-3px); background: rgba(255,255,255,0.1); border-color: #fff; }
  .btn-action:not(:disabled):active { transform: scale(0.95); }
  
  .btn-key { 
    position: absolute; top: -10px; background: #fff; color: #000; 
    font-weight: bold; width: 24px; height: 24px; border-radius: 50%; 
    display:grid; place-items:center; font-size: 0.8rem; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  
  .btn-action.safe { border-bottom: 4px solid var(--safe); }
  .btn-action.warn { border-bottom: 4px solid var(--warn); }
  .btn-action.help { border-bottom: 4px solid var(--danger); }

  .btn-icon-big { font-size: 2rem; margin-bottom: 5px; }
  .btn-label { font-size: 0.9rem; font-weight: 700; line-height: 1.1; text-align: center; }

  /* --- STATS --- */
  .stats-bar {
    display:flex; justify-content:space-between; align-items:center;
    background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 20px;
    font-size: 0.9rem; margin-bottom: 1rem;
  }
  .score-box { display:flex; gap:10px; }
  .progress-container { width: 100px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow:hidden; }
  .progress-fill { width: 0%; height: 100%; background: var(--gold); transition: width 0.3s; }

  /* --- MODAL --- */
  .overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:100;
    display:grid; place-items:center; padding:1rem;
    opacity:0; pointer-events:none; transition: opacity 0.3s;
  }
  .overlay.active { opacity:1; pointer-events:all; }
  
  .modal {
    background: #fff; color: #1a1a1a; max-width: 500px; width: 100%;
    border-radius: 16px; padding: 2rem; text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateY(20px);
    transition: transform 0.3s;
  }
  .overlay.active .modal { transform: translateY(0); }
  .modal h2 { margin-top:0; color: var(--accent); }
  .modal p { font-size: 1.1rem; line-height: 1.5; color: #444; }
  
  .btn-start {
    background: var(--accent); color: white; border: none;
    padding: 12px 30px; font-size: 1.1rem; font-weight: bold;
    border-radius: 50px; cursor: pointer; margin-top: 1rem;
    box-shadow: 0 4px 15px rgba(94, 73, 255, 0.4);
    transition: transform 0.1s;
  }
  .btn-start:hover { transform: scale(1.05); }

  /* Toast */
  .toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: #333; color: #fff; padding: 10px 20px; border-radius: 30px;
    opacity: 0; transition: all 0.3s; font-weight: bold; z-index: 50;
    display: flex; gap: 10px; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.success { background: var(--safe); color: #003300; }
  .toast.warning { background: var(--warn); color: #554400; }
  .toast.danger { background: var(--danger); color: #550000; }
  .toast.info { background: var(--accent); color: #fff; }

  /* Tutorial Mode */
  body.tutorial-mode .btn-action { filter: grayscale(1); opacity: 0.4; }
  body.tutorial-mode .btn-action.highlight { filter: none; opacity: 1; border-color: var(--gold); transform: scale(1.05); box-shadow: 0 0 20px var(--gold); animation: pulse 1s infinite; }
  @keyframes pulse { 50% { box-shadow: 0 0 5px var(--gold); } }

</style>
</head>
<body>

<header>
  <div class="title">
    <div class="spark"></div>
    LA BIBLIOTECA INFINITA
  </div>
  <button class="btn-icon" id="btnMute" title="Silenciar">üîä</button>
</header>

<main>
  <div class="stats-bar">
    <div class="score-box">
      <span>‚≠ê Puntos: <b id="scoreVal">0</b></span>
      <span style="margin-left:10px">‚ù§Ô∏è Intentos: <b id="livesVal">3</b></span>
    </div>
    <div style="display:flex; align-items:center; gap:5px">
      <small>Progreso</small>
      <div class="progress-container"><div class="progress-fill" id="progBar"></div></div>
    </div>
  </div>

  <div class="librarian-area">
    <div class="avatar">
      <div style="width:100%; height:100%; display:grid; place-items:center; font-size:35px; background:#eee;">üë©‚Äçüè´</div>
    </div>
    <div class="dialog-bubble" id="librarianText">
      ¬°Bienvenido, Guardi√°n! Esperando iniciar sistema...
    </div>
  </div>

  <div class="book-stage" id="stage"></div>

  <div class="controls" id="controls">
    <button class="btn-action safe" id="btn1" onclick="playerAction('safe')">
      <div class="btn-key">1</div>
      <div class="btn-icon-big">‚úÖ</div>
      <div class="btn-label">SALA<br>SEGURA</div>
    </button>
    <button class="btn-action warn" id="btn2" onclick="playerAction('warn')">
      <div class="btn-key">2</div>
      <div class="btn-icon-big">‚ùì</div>
      <div class="btn-label">ZONA<br>CUARENTENA</div>
    </button>
    <button class="btn-action help" id="btn3" onclick="playerAction('help')">
      <div class="btn-key">3</div>
      <div class="btn-icon-big">üßë‚Äçüè´</div>
      <div class="btn-label">MOSTRADOR<br>AYUDA</div>
    </button>
  </div>
</main>

<div class="overlay active" id="startOverlay">
  <div class="modal">
    <div style="font-size:3rem; margin-bottom:10px">üìö</div>
    <h2>Guardianes del Conocimiento</h2>
    <p>¬°Hola Guardi√°n! La Biblioteca Infinita tiene nuevos libros y necesito tu ayuda para organizarlos.</p>
    <p>¬øEst√°s listo para el entrenamiento?</p>
    <button class="btn-start" onclick="iniciarTutorial()">¬°Comenzar Entrenamiento!</button>
  </div>
</div>

<div class="overlay" id="endOverlay">
  <div class="modal">
    <div style="font-size:3rem; margin-bottom:10px" id="endIcon">üèÜ</div>
    <h2 id="endTitle">¬°Misi√≥n Cumplida!</h2>
    <p id="endMsg">Resumen del juego...</p>
    <button class="btn-start" onclick="restartGame()">Jugar Otra Vez</button>
  </div>
</div>

<div class="toast" id="toast">
  <span id="toastIcon">‚ÑπÔ∏è</span> <span id="toastMsg">Mensaje</span>
</div>

<script>
  /* --- CONFIGURACI√ìN --- */
  const GAME = {
    state: 'MENU', 
    score: 0,
    lives: 3,
    bookIndex: 0,
    tutorialStep: 0,
    currentBook: null,
    queue: []
  };

  const AUDIO_CTX = new (window.AudioContext || window.webkitAudioContext)();
  let IS_MUTED = false;

  // Libros Tutorial
  const TUTORIAL_BOOKS = [
    { 
      id: 'tut1', title: 'MiEscuela.edu.mx', tld: '.edu.mx', type: 'school', correct: 'safe', 
      msg: '¬°Hola! Primero, mira este libro. Tiene el <b>escudo de nuestra escuela</b>. ¬°Es nuestro patio digital! Estos siempre van a la <b>Sala Segura (1)</b>.' 
    },
    { 
      id: 'tut2', title: 'CienciaDivertida.org', tld: '.org', type: 'safe', correct: 'safe', 
      msg: 'Ahora mira el final del t√≠tulo. Termina en <b>.org</b>. Las terminaciones <b>.edu, .gob y .org</b> suelen ser confiables. ¬°A la <b>Sala Segura (1)</b>!' 
    },
    { 
      id: 'tut3', title: 'GanarPremios.biz', tld: '.biz', type: 'warn', correct: 'warn', 
      msg: '¬°Alerta! Mira este libro. Tiene una terminaci√≥n rara <b>.biz</b> y portada roja sospechosa. Los sitios enga√±osos o con virus van a la <b>Zona de Cuarentena (2)</b>.' 
    },
    { 
      id: 'tut4', title: 'JuegosGratis.info', tld: '.info', type: 'ads', correct: 'help', 
      msg: 'Finalmente, este termina en <b>.info</b> y tiene anuncios extra√±os. Si no est√°s seguro de d√≥nde va, ¬°no adivines! Usa el <b>Mostrador de Ayuda (3)</b>.' 
    }
  ];

  // Datos para Generaci√≥n Aleatoria
  const DOMAINS = {
    safe: ['.edu', '.gob', '.org'],
    ambiguous: ['.com', '.net'],
    bad: ['.biz', '.info', '.xyz', '.net.biz']
  };
  
  // Lista ampliada para mejor aleatoriedad
  const NAMES = [
    'PlanetaAnimal', 'HistoriaMundial', 'MatematicasFaciles', 'NoticiasVirales', 'GanaPremios', 
    'ClubLectura', 'MuseoVirtual', 'VideojuegosPro', 'RecetasAbuela', 'EspacioExterior', 
    'DinosauriosVivos', 'RobotAmigo', 'SuperCoche', 'MagiaNegra', 'TrucosFortnite', 'DescargaYa',
    'AulaCiencia', 'AyudaTareas', 'CuentosMagicos', 'LaboratorioX'
  ];

  /* Funci√≥n de barajado (Fisher-Yates) */
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  /* Generador de Cola Balanceada y Aleatoria */
  function generarColaDeJuego() {
    let cola = [];
    
    // Barajamos nombres para no repetir
    const shuffledNames = shuffleArray([...NAMES]);
    
    // Crear "Bolsa" de libros: 3 Seguros, 3 Malos, 4 Ambiguos/Ayuda = 10 Total
    const tipos = [
      'safe', 'safe', 'safe',
      'bad', 'bad', 'bad',
      'ambiguous', 'ambiguous', 'ambiguous', 'ambiguous'
    ];
    
    // Barajar los tipos
    const shuffledTypes = shuffleArray(tipos);
    
    for(let i=0; i<10; i++) {
      let type = shuffledTypes[i];
      let book = {};
      let name = shuffledNames[i];
      
      if(type === 'safe') {
        let tld = DOMAINS.safe[Math.floor(Math.random()*DOMAINS.safe.length)];
        book = { title: name + tld, tld: tld, type: 'safe', correct: 'safe' };
      } else if (type === 'bad') {
        let tld = DOMAINS.bad[Math.floor(Math.random()*DOMAINS.bad.length)];
        let isTrap = Math.random() < 0.5;
        let fullTld = isTrap ? '.org.biz' : tld;
        book = { title: name + fullTld, tld: fullTld, type: isTrap ? 'warn' : 'ads', correct: 'warn' };
      } else { // ambiguous
        let tld = DOMAINS.ambiguous[Math.floor(Math.random()*DOMAINS.ambiguous.length)];
        book = { title: name + tld, tld: tld, type: 'safe', correct: 'help' };
      }
      cola.push(book);
    }
    return cola;
  }

  /* --- SISTEMA DE AUDIO --- */
  function playSound(type) {
    if(IS_MUTED) return;
    if(AUDIO_CTX.state === 'suspended') AUDIO_CTX.resume();
    const osc = AUDIO_CTX.createOscillator();
    const gain = AUDIO_CTX.createGain();
    
    if(type === 'correct') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(500, AUDIO_CTX.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1000, AUDIO_CTX.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, AUDIO_CTX.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, AUDIO_CTX.currentTime + 0.3);
      osc.start(); osc.stop(AUDIO_CTX.currentTime + 0.3);
    } else if(type === 'error') {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, AUDIO_CTX.currentTime);
      osc.frequency.linearRampToValueAtTime(100, AUDIO_CTX.currentTime + 0.2);
      gain.gain.setValueAtTime(0.1, AUDIO_CTX.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, AUDIO_CTX.currentTime + 0.3);
      osc.start(); osc.stop(AUDIO_CTX.currentTime + 0.3);
    } else if(type === 'pop') {
      osc.type = 'triangle'; osc.frequency.setValueAtTime(400, AUDIO_CTX.currentTime);
      gain.gain.setValueAtTime(0.05, AUDIO_CTX.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, AUDIO_CTX.currentTime + 0.1);
      osc.start(); osc.stop(AUDIO_CTX.currentTime + 0.1);
    }
    osc.connect(gain); gain.connect(AUDIO_CTX.destination);
  }

  function speak(text) {
    if(IS_MUTED || !('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const cleanText = text.replace(/<[^>]*>?/gm, '');
    const u = new SpeechSynthesisUtterance(cleanText);
    u.lang = 'es-MX'; u.rate = 1.1; u.pitch = 1.1;
    window.speechSynthesis.speak(u);
  }

  /* --- LOGICA UI --- */
  function updateUI() {
    document.getElementById('scoreVal').innerText = GAME.score;
    document.getElementById('livesVal').innerText = GAME.lives;
    let total = GAME.state === 'TUTORIAL' ? 4 : 10;
    let current = GAME.state === 'TUTORIAL' ? GAME.tutorialStep : GAME.bookIndex;
    let pct = (current / total) * 100;
    document.getElementById('progBar').style.width = pct + '%';
  }

  function showToast(msg, type) {
    const t = document.getElementById('toast');
    const i = document.getElementById('toastIcon');
    const m = document.getElementById('toastMsg');
    t.className = `toast show ${type}`;
    i.innerText = type === 'success' ? '‚úÖ' : type === 'danger' ? 'üö®' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    m.innerText = msg;
    setTimeout(() => t.className = 'toast', 2500);
  }

  function setLibrarianText(html) {
    const el = document.getElementById('librarianText');
    el.innerHTML = html;
    speak(html);
  }

  function renderBook(bookData) {
    const stage = document.getElementById('stage');
    stage.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'book anim-enter';
    div.dataset.type = bookData.type;
    
    let seal = 'üìñ';
    if(bookData.type === 'school') seal = 'üè´';
    if(bookData.type === 'ads') seal = '‚ö†Ô∏è';
    if(bookData.type === 'warn') seal = 'ü¶†';

    const titleParts = bookData.title.split(bookData.tld);
    const displayTitle = titleParts[0] + `<span class="book-tld">${bookData.tld}</span>`;

    div.innerHTML = `<div class="book-title">${displayTitle}</div><div class="book-seal">${seal}</div>`;
    stage.appendChild(div);
    playSound('pop');
  }

  /* --- TUTORIAL --- */
  function iniciarTutorial() {
    document.getElementById('startOverlay').classList.remove('active');
    GAME.state = 'TUTORIAL';
    GAME.tutorialStep = 0;
    document.body.classList.add('tutorial-mode');
    runTutorialStep();
  }

  function runTutorialStep() {
    if(GAME.tutorialStep >= TUTORIAL_BOOKS.length) {
      finTutorial();
      return;
    }
    const book = TUTORIAL_BOOKS[GAME.tutorialStep];
    GAME.currentBook = book;
    renderBook(book);
    setLibrarianText(book.msg);
    updateUI();
    const btns = ['safe', 'warn', 'help']; 
    const map = { 'safe': 'btn1', 'warn': 'btn2', 'help': 'btn3' };
    btns.forEach(b => {
      const el = document.getElementById(map[b]);
      el.disabled = (b !== book.correct);
      if(b === book.correct) el.classList.add('highlight');
      else el.classList.remove('highlight');
    });
  }

  function finTutorial() {
    GAME.state = 'PLAYING';
    GAME.bookIndex = 0;
    document.body.classList.remove('tutorial-mode');
    ['btn1','btn2','btn3'].forEach(id => {
      const el = document.getElementById(id);
      el.disabled = false;
      el.classList.remove('highlight');
    });
    GAME.queue = generarColaDeJuego();
    setLibrarianText("¬°Entrenamiento completo! Ahora te toca a ti. <b>Clasifica 10 libros</b>. ¬°Suerte!");
    nextBook();
  }

  /* --- GAME LOGIC --- */
  function nextBook() {
    if(GAME.bookIndex >= GAME.queue.length) {
      endGame(true);
      return;
    }
    GAME.currentBook = GAME.queue[GAME.bookIndex];
    renderBook(GAME.currentBook);
    updateUI();
  }

  function playerAction(action) {
    if(!GAME.currentBook) return;
    const bookEl = document.querySelector('.book');
    let points = 0;
    
    if(action === 'help') {
      handleHelpRequest(bookEl);
      return; 
    }

    if(GAME.state === 'TUTORIAL') {
       if(action === GAME.currentBook.correct) stepSuccess(action, bookEl);
       return;
    }

    if(action === GAME.currentBook.correct || (GAME.currentBook.correct === 'help' && action === 'warn')) {
      points = 10;
      playSound('correct');
      showToast("¬°Correcto!", "success");
      setLibrarianText("¬°Bien visto!");
    } else {
      playSound('error');
      GAME.lives--;
      GAME.score = Math.max(0, GAME.score - 5);
      if(GAME.currentBook.correct === 'warn' && action === 'safe') {
        showToast("¬°PELIGRO! Era inseguro.", "danger");
        setLibrarianText("¬°Oh no! Ese libro ten√≠a trucos.");
      } else {
        showToast("Ups, no era ah√≠.", "warning");
        setLibrarianText("M√°s atenci√≥n a las pistas.");
      }
    }
    animateAndNext(bookEl, action, points);
  }

  function handleHelpRequest(bookEl) {
    bookEl.classList.add('anim-help');
    playSound('pop');
    const hints = ["D√©jame ver...", "Revisando bases de datos...", "Buena pregunta..."];
    const intro = hints[Math.floor(Math.random()*hints.length)];
    let bonus = 0;
    let feedback = "";
    
    if(GAME.currentBook.correct === 'help' || GAME.currentBook.correct === 'warn') {
      bonus = 15;
      feedback = "¬°Bien hecho! Es sospechoso, va a <b>Cuarentena</b>.";
      showToast("¬°Sabidur√≠a! +15", "info");
      playSound('correct');
    } else {
      bonus = 5;
      feedback = "Es seguro, lo pondr√© en <b>Sala Segura</b>.";
      showToast("Precavido +5", "info");
      playSound('correct');
    }
    setLibrarianText(`<i>${intro}</i> ${feedback}`);
    GAME.score += bonus;
    updateUI();

    setTimeout(() => {
      if(GAME.state === 'TUTORIAL') {
        GAME.tutorialStep++;
        runTutorialStep();
      } else {
        GAME.bookIndex++;
        nextBook();
      }
    }, 2500);
  }

  function stepSuccess(action, el) {
    playSound('correct');
    animateAndNext(el, action, 0);
    setTimeout(() => { GAME.tutorialStep++; runTutorialStep(); }, 600);
  }

  function animateAndNext(el, action, points) {
    if(action === 'safe') el.classList.add('anim-safe');
    else if(action === 'warn') el.classList.add('anim-warn');
    GAME.score += points;
    updateUI();

    if(GAME.lives <= 0) {
      setTimeout(() => endGame(false), 500);
      return;
    }
    if(GAME.state !== 'TUTORIAL') {
      setTimeout(() => { GAME.bookIndex++; nextBook(); }, 600);
    }
  }

  function endGame(win) {
    GAME.state = 'END';
    const ov = document.getElementById('endOverlay');
    const tit = document.getElementById('endTitle');
    const msg = document.getElementById('endMsg');
    const ico = document.getElementById('endIcon');
    ov.classList.add('active');
    if(win) {
      tit.innerText = "¬°Misi√≥n Cumplida!";
      ico.innerText = "üóùÔ∏è";
      msg.innerHTML = `¬°Felicidades Guardi√°n!<br>Has obtenido la <b>Llave Dorada</b>.<br>Puntuaci√≥n Final: <b>${GAME.score}</b>`;
      playSound('correct');
    } else {
      tit.innerText = "¬°Alerta de Seguridad!";
      ico.innerText = "üõë";
      msg.innerHTML = "Se colaron libros peligrosos.<br>Repasemos las pistas.";
      playSound('error');
    }
  }

  function restartGame() {
    // Reset Total
    GAME.score = 0;
    GAME.lives = 3;
    GAME.bookIndex = 0;
    GAME.state = 'PLAYING';
    GAME.queue = generarColaDeJuego();
    
    // UI Reset
    document.getElementById('endOverlay').classList.remove('active');
    document.body.classList.remove('tutorial-mode');
    ['btn1','btn2','btn3'].forEach(id => {
      const el = document.getElementById(id);
      el.disabled = false;
      el.classList.remove('highlight');
    });
    
    setLibrarianText("¬°Nueva ronda! ¬°A clasificar!");
    nextBook();
  }

  /* --- INPUTS --- */
  document.addEventListener('keydown', (e) => {
    if(document.querySelector('.overlay.active')) return;
    if(e.key === '1') document.getElementById('btn1').click();
    if(e.key === '2') document.getElementById('btn2').click();
    if(e.key === '3') document.getElementById('btn3').click();
  });

  document.getElementById('btnMute').onclick = () => {
    IS_MUTED = !IS_MUTED;
    document.getElementById('btnMute').innerText = IS_MUTED ? 'üîá' : 'üîä';
  };
</script>
</body>
</html>
